name: Autopilot Auditor

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Automatically create fix PR if drift is detected'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-drift:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Detect drift
        id: drift
        continue-on-error: true
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          DRIFT_REPORT_FILE: drift-report.json
        run: |
          python .github/scripts/detect_drift.py .github/governance/manifest.yml .

      - name: Upload drift report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: drift-report
          path: drift-report.json

      - name: Check drift status
        id: check
        run: |
          if [ -f drift-report.json ]; then
            DRIFT_DETECTED=$(jq -r '.drift_detected' drift-report.json)
            echo "drift_detected=$DRIFT_DETECTED" >> $GITHUB_OUTPUT
            
            if [ "$DRIFT_DETECTED" = "true" ]; then
              echo "⚠️ Drift detected!"
              jq -r '.violations[] | "- \(.type): \(.message)"' drift-report.json
            else
              echo "✅ No drift detected"
            fi
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Create fix PR
        if: steps.check.outputs.drift_detected == 'true' && (github.event.inputs.auto_fix == 'true' || github.event_name == 'schedule')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "autopilot-auditor[bot]"
          git config user.email "autopilot-auditor[bot]@users.noreply.github.com"
          python .github/scripts/create_fix_pr.py drift-report.json

      - name: Record audit event
        if: always()
        run: |
          mkdir -p .github/governance
          
          # Create or update events log
          if [ ! -f .github/governance/events.json ]; then
            echo "[]" > .github/governance/events.json
          fi
          
          # Add new event
          EVENT=$(jq -n \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg type "audit_run" \
            --arg repo "${{ github.repository }}" \
            --arg actor "${{ github.actor }}" \
            --argjson drift_detected "${{ steps.check.outputs.drift_detected }}" \
            '{
              timestamp: $timestamp,
              type: $type,
              repository: $repo,
              actor: $actor,
              data: {
                drift_detected: $drift_detected,
                run_id: "${{ github.run_id }}",
                trigger: "${{ github.event_name }}"
              }
            }')
          
          jq ". += [$EVENT]" .github/governance/events.json > events.tmp
          mv events.tmp .github/governance/events.json

      - name: Compute Merkle checkpoint
        if: always()
        id: checkpoint
        run: |
          echo "Computing Merkle checkpoint..."
          if bun run scripts/compute-merkle.ts compute .github/governance/events.json .github/governance/checkpoint.json; then
            echo "checkpoint_created=true" >> $GITHUB_OUTPUT
            echo "✓ Checkpoint computed successfully"
          else
            echo "checkpoint_created=false" >> $GITHUB_OUTPUT
            echo "✗ Failed to compute checkpoint"
            exit 1
          fi

      - name: Update manifest with Merkle root
        if: always() && steps.checkpoint.outputs.checkpoint_created == 'true'
        run: |
          if [ -f .github/governance/checkpoint.json ]; then
            MERKLE_ROOT=$(jq -r '.root_hash' .github/governance/checkpoint.json)
            TIMESTAMP=$(jq -r '.timestamp' .github/governance/checkpoint.json)
            
            # Install yq if not available
            if ! command -v yq &> /dev/null; then
              pip install yq
            fi
            
            # Update manifest with new Merkle root
            yq eval ".control_plane.merkle_root = \"$MERKLE_ROOT\"" -i .github/governance/manifest.yml
            yq eval ".control_plane.last_audit = \"$TIMESTAMP\"" -i .github/governance/manifest.yml
            
            echo "Updated manifest with Merkle root: $MERKLE_ROOT"
          fi

      - name: Commit and push checkpoint updates
        if: always() && steps.checkpoint.outputs.checkpoint_created == 'true'
        run: |
          git config user.name "autopilot-auditor[bot]"
          git config user.email "autopilot-auditor[bot]@users.noreply.github.com"
          
          git add .github/governance/events.json
          git add .github/governance/checkpoint.json
          git add .github/governance/manifest.yml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update governance checkpoint

Merkle root: $(jq -r '.root_hash' .github/governance/checkpoint.json)
Event count: $(jq -r '.event_count' .github/governance/checkpoint.json)
Timestamp: $(jq -r '.timestamp' .github/governance/checkpoint.json)

[skip ci]"
            git push
            echo "✓ Checkpoint committed and pushed"
          fi

  verify-checkpoint:
    runs-on: ubuntu-latest
    needs: detect-drift
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.6'

      - name: Verify Merkle checkpoint
        run: |
          if [ -f .github/governance/checkpoint.json ]; then
            echo "Verifying Merkle checkpoint..."
            bun run scripts/compute-merkle.ts verify .github/governance/checkpoint.json
            echo "✅ Checkpoint verified"
          else
            echo "No checkpoint found to verify"
          fi
