name: Autopilot Auditor

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'Create correction PR if drift detected'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  detect-drift:
    name: Detect Workflow Drift
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
      merkle_root: ${{ steps.drift.outputs.merkle_root }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run drift detection
        id: drift
        continue-on-error: true
        run: |
          python .github/scripts/detect_drift.py || true
          
          # Always capture outputs from report file
          if [ -f drift-report.json ]; then
            drift_detected=$(jq -r '.drift_detected' drift-report.json)
            merkle_root=$(jq -r '.state.merkle_root' drift-report.json)
            
            echo "drift_detected=$drift_detected" >> $GITHUB_OUTPUT
            echo "merkle_root=$merkle_root" >> $GITHUB_OUTPUT
            
            # Also set as environment variables for later steps
            echo "DRIFT_DETECTED=$drift_detected" >> $GITHUB_ENV
            echo "MERKLE_ROOT=$merkle_root" >> $GITHUB_ENV
          else
            # If no report, assume no drift
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "merkle_root=" >> $GITHUB_OUTPUT
          fi

      - name: Upload drift report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drift-report
          path: drift-report.json
          retention-days: 30

      - name: Create issue if drift detected
        if: steps.drift.outcome == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('drift-report.json', 'utf8'));
            
            const title = `ðŸš¨ Governance Drift Detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Autonomous Governance Audit
            
            **Status:** ${report.status}
            **Merkle Root:** \`${report.state.merkle_root}\`
            **Violations:** ${report.violation_count}
            **Timestamp:** ${report.timestamp}
            
            ### Violations Detected
            
            ${report.violations.map(v => `
            #### âŒ ${v.file}
            - **Type:** ${v.violation_type}
            - **Message:** ${v.message}
            ${v.lines ? `- **Lines:** ${v.lines.join(', ')}` : ''}
            `).join('\n')}
            
            ### Remediation Required
            
            This repository has drifted from the governance policies enforced by the autonomous control plane.
            
            **Next Steps:**
            1. Review the violations above
            2. Run \`gh workflow run autopilot-audit.yml -f create_pr=true\` to generate correction PR
            3. Review and merge the correction PR
            
            **Epistemic Continuity:** This drift detection is bound to the Merkle root above, ensuring immutable verification of repository state.
            
            ---
            *This issue was automatically created by the Autopilot Auditor*`;
            
            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['governance', 'drift-detected'],
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['governance', 'drift-detected', 'autopilot'],
              });
              
              console.log('âœ… Created drift detection issue');
            } else {
              console.log('â„¹ï¸  Drift issue already exists, skipping creation');
            }

  auto-correct:
    name: Autonomous Correction
    runs-on: ubuntu-latest
    needs: detect-drift
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.create_pr == true) ||
      (needs.detect-drift.outputs.drift_detected == 'true' && github.event_name == 'schedule')
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download drift report
        uses: actions/download-artifact@v4
        with:
          name: drift-report

      - name: Generate correction branch
        id: correction
        run: |
          # Create correction branch
          timestamp=$(date +%Y%m%d-%H%M%S)
          branch_name="autopilot/drift-correction-${timestamp}"
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git checkout -b "$branch_name"
          
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          
          # Add drift report to branch
          git add drift-report.json
          git commit -m "chore: add drift report for $timestamp

          Merkle Root: ${{ needs.detect-drift.outputs.merkle_root }}
          Drift Detected: ${{ needs.detect-drift.outputs.drift_detected }}
          
          This commit preserves epistemic continuity by binding the detected
          drift to an immutable Merkle root, enabling verifiable transformations."

      - name: Add missing governance files
        run: |
          # Check if policy files exist, if not copy from control plane
          if [ ! -f .github/workflows/policy.yml ]; then
            echo "Adding missing policy.yml"
            # In a real implementation, this would fetch from control plane
            # For now, just note the missing file
            echo "policy.yml" >> .missing-files.txt
          fi
          
          if [ ! -f .github/workflows/reusable-policy.yml ]; then
            echo "Adding missing reusable-policy.yml"
            echo "reusable-policy.yml" >> .missing-files.txt
          fi
          
          if [ -f .missing-files.txt ]; then
            git add .missing-files.txt
            git commit -m "docs: document missing governance files" || true
          fi

      - name: Push correction branch
        run: |
          git push origin ${{ steps.correction.outputs.branch_name }}

      - name: Create correction PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('drift-report.json', 'utf8'));
            
            const title = `ðŸ¤– Autonomous Governance Correction`;
            const body = `## Autonomous Drift Correction
            
            This PR was **automatically generated** by the Autopilot Auditor to correct detected governance drift.
            
            ### Drift Report
            
            **Merkle Root:** \`${report.state.merkle_root}\`
            **Violations:** ${report.violation_count}
            **Status:** ${report.status}
            **Timestamp:** ${report.timestamp}
            
            ### Changes
            
            ${report.violations.map(v => `
            - **${v.file}**: ${v.message}
            `).join('\n')}
            
            ### Epistemic Continuity
            
            This correction is bound to the Merkle root \`${report.state.merkle_root}\`, ensuring:
            - **Immutability**: The detected drift state is cryptographically committed
            - **Verifiability**: Any future audits can verify this transformation
            - **Auditability**: The correction is traceable to the original drift detection
            
            ### Action Required
            
            1. Review the changes
            2. Approve the PR if corrections are valid
            3. Merge to apply autonomous corrections
            
            ---
            *This PR was created by the Autopilot Auditor - the autonomous governance system*
            
            **Control Plane:** EvezArt/crawhub
            **Policy:** Thin-Caller CI Enforcement`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              head: '${{ steps.correction.outputs.branch_name }}',
              base: 'main',
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['governance', 'autopilot', 'drift-correction'],
            });
            
            console.log(`âœ… Created correction PR #${pr.data.number}`);
            console.log(`URL: ${pr.data.html_url}`);
