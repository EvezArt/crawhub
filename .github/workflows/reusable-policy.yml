name: Reusable Thin-Caller Policy Check

on:
  workflow_call:
    inputs:
      allowlist:
        description: >
          Comma-separated list of workflow files to exclude from
          thin-caller checks
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  check-thin-caller:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check thin-caller policy
        shell: bash
        run: |
          set -e

          ALLOWLIST="${{ inputs.allowlist }}"
          VIOLATIONS=()

          echo "üîç Checking workflows for thin-caller policy..."
          echo ""

          # Convert allowlist to array
          IFS=',' read -ra ALLOWED_FILES <<< "$ALLOWLIST"

          # Find all workflow files
          WORKFLOWS=$(
            find .github/workflows -type f \
              \( -name "*.yml" -o -name "*.yaml" \) \
            2>/dev/null || echo ""
          )

          if [ -z "$WORKFLOWS" ]; then
            echo "‚úÖ No workflow files found to check"
            exit 0
          fi

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            filename=$(basename "$file")

            # Check if file is in allowlist
            is_allowed=false
            for allowed in "${ALLOWED_FILES[@]}"; do
              if [ "$(echo "$allowed" | xargs)" = "$filename" ]; then
                echo "‚è≠Ô∏è  Skipping $filename (allowlisted)"
                is_allowed=true
                break
              fi
            done

            if [ "$is_allowed" = true ]; then
              continue
            fi

            echo "üìÑ Checking $filename..."

            # Check for 'run:' steps (indicates thick caller)
            # Matches both "- run:" and "  run:" patterns
            if grep -E "^[[:space:]]+(- )?run:" "$file" \
              > /dev/null 2>&1; then
              echo "  ‚ùå Found local 'run:' steps"
              VIOLATIONS+=("$filename: Contains local 'run:' steps")
            fi

            # Check if workflow uses reusable workflows
            uses_count=$(
              grep -E "^[[:space:]]*(-[[:space:]]*uses:|uses:[[:space:]]+)" \
                "$file" | wc -l || echo "0"
            )

            if [ "$uses_count" -eq 0 ]; then
              echo "  ‚ö†Ô∏è  No reusable workflow references found"
            else
              echo "  ‚úÖ Uses reusable workflows"
              echo "     ($uses_count uses statements)"
            fi

            echo ""
          done <<< "$WORKFLOWS"

          # Report results
          if [ ${#VIOLATIONS[@]} -gt 0 ]; then
            echo "‚ùå Thin-caller policy violations found:"
            echo ""
            for violation in "${VIOLATIONS[@]}"; do
              echo "  - $violation"
            done
            echo ""
            echo "‚ÑπÔ∏è  Thin-caller policy requires workflows to"
            echo "   delegate to reusable workflows instead of"
            echo "   containing local 'run:' steps. This improves"
            echo "   consistency, maintainability, and security."
            echo ""
            echo "   To fix: Move logic to reusable workflows or"
            echo "   add the file to the allowlist."
            exit 1
          else
            echo "‚úÖ All workflows comply with thin-caller policy"
            exit 0
          fi
